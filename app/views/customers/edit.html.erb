<!-- app/views/customers/edit.html.erb -->

<div class="yae-profile-page">
  <div class="container my-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb yae-breadcrumb">
        <li class="breadcrumb-item">
          <%= link_to root_path do %>
            <i class="bi bi-house-fill me-1"></i>Home
          <% end %>
        </li>
        <li class="breadcrumb-item">
          <%= link_to customer_profile_path do %>
            My Account
          <% end %>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Edit Profile</li>
      </ol>
    </nav>

    <div class="row justify-content-center">
      <div class="col-lg-9">
        <div class="yae-edit-card">
          <div class="yae-card-header">
            <h4 class="mb-0"><i class="bi bi-pencil-square me-2"></i> Edit Profile</h4>
          </div>
          <div class="yae-card-body">
            <!-- Pure HTML Form -->
            <form action="/profile" method="POST" enctype="multipart/form-data">
              <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
              <input type="hidden" name="_method" value="PATCH">
              
              <% if @customer.errors.any? %>
                <div class="yae-alert yae-alert-danger">
                  <h5 class="yae-alert-heading">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <%= pluralize(@customer.errors.count, "error") %> prohibited this profile from being saved:
                  </h5>
                  <ul class="mb-0">
                    <% @customer.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <!-- Personal Information -->
              <div class="yae-form-section">
                <h5 class="yae-section-title">
                  <i class="bi bi-person-fill me-2"></i>Personal Information
                </h5>

                <!-- Profile Picture Section -->
                <% if @customer.profile_picture.attached? %>
                  <div class="yae-profile-picture-section">
                    <div style="font-weight: 700; margin-bottom: 0.5rem;">Profile Picture</div>
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                      <%= image_tag @customer.profile_picture.variant(resize_to_fill: [100, 100]), 
                          class: 'yae-current-avatar' %>
                      <div class="flex-grow-1">
                        <input type="file" name="customer[profile_picture]" id="customer_profile_picture"
                               accept="image/png,image/jpeg,image/jpg,image/gif" class="yae-file-input">
                        <small class="yae-help-text">
                          <i class="bi bi-info-circle me-1"></i>JPG, PNG, or GIF. Max size 5MB.
                        </small>
                      </div>
                    </div>
                  </div>
                  <hr class="yae-divider">
                <% end %>
                
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="customer_first_name" class="yae-label">First name</label>
                    <input type="text" name="customer[first_name]" id="customer_first_name" 
                           value="<%= @customer.first_name %>" class="yae-input" placeholder="First Name" required>
                  </div>
                  <div class="col-md-6">
                    <label for="customer_last_name" class="yae-label">Last name</label>
                    <input type="text" name="customer[last_name]" id="customer_last_name" 
                           value="<%= @customer.last_name %>" class="yae-input" placeholder="Last Name" required>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="customer_email" class="yae-label">Email</label>
                  <input type="email" name="customer[email]" id="customer_email" 
                         value="<%= @customer.email %>" class="yae-input" placeholder="your.email@example.com" required>
                  <small class="yae-help-text">
                    <i class="bi bi-shield-check me-1"></i>We'll never share your email with anyone else.
                  </small>
                </div>
              </div>

              <hr class="yae-section-divider">

              <!-- Shipping Address -->
              <div class="yae-form-section">
                <h5 class="yae-section-title">
                  <i class="bi bi-geo-alt-fill me-2"></i>Shipping Address <span class="yae-optional">(Optional)</span>
                </h5>

                <!-- Region Selection Toggle -->
                <div class="country-toggle mb-4">
                  <label class="form-label fw-bold">
                    <i class="bi bi-globe me-2"></i>Shipping Region
                  </label>
                  <div class="btn-group-custom" role="group">
                    <input type="radio" name="customer[is_canada]" value="1" 
                           <%= 'checked' if @customer.province_id.present? %>
                           class="btn-check" id="canada_shipping">
                    <label class="btn btn-outline-primary btn-region" for="canada_shipping">
                      <i class="bi bi-flag me-2"></i>Canada
                    </label>
                    
                    <input type="radio" name="customer[is_canada]" value="0" 
                           class="btn-check" id="teyvat_shipping" data-region="teyvat">
                    <label class="btn btn-outline-primary btn-region" for="teyvat_shipping">
                      <i class="bi bi-stars me-2"></i>Teyvat
                    </label>
                    
                    <input type="radio" name="customer[is_canada]" value="0"
                           <%= 'checked' if @customer.country_id.present? && !['MD', 'LY', 'IZ', 'SM', 'FT', 'NT', 'SN', 'KH', 'NK'].include?(@customer.country&.code) %>
                           class="btn-check" id="international_shipping" data-region="international">
                    <label class="btn btn-outline-primary btn-region" for="international_shipping">
                      <i class="bi bi-airplane me-2"></i>International
                    </label>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label for="customer_address_line1" class="yae-label">Address Line 1</label>
                  <input type="text" name="customer[address_line1]" id="customer_address_line1" 
                         value="<%= @customer.address_line1 %>" class="yae-input" placeholder="123 Main Street">
                </div>

                <div class="mb-3">
                  <label for="customer_address_line2" class="yae-label">Address Line 2 (Optional)</label>
                  <input type="text" name="customer[address_line2]" id="customer_address_line2" 
                         value="<%= @customer.address_line2 %>" class="yae-input" placeholder="Apt 4B, Unit 2, etc.">
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="customer_city" class="yae-label">City</label>
                    <input type="text" name="customer[city]" id="customer_city" 
                           value="<%= @customer.city %>" class="yae-input" placeholder="City">
                  </div>

                  <!-- Canadian Province -->
                  <div class="col-md-6" id="province_field">
                    <label for="customer_province_id" class="yae-label">Province</label>
                    <select name="customer[province_id]" id="customer_province_id" class="yae-select">
                      <option value="">Select Province</option>
                      <% Province.all.each do |province| %>
                        <option value="<%= province.id %>" <%= 'selected' if @customer.province_id == province.id %>>
                          <%= province.name %>
                        </option>
                      <% end %>
                    </select>
                  </div>

                  <!-- International/Teyvat Country -->
                  <div class="col-md-6" id="country_field" style="display: none;">
                    <label for="customer_country_id" class="yae-label">
                      <span id="country_label">Country</span>
                    </label>
                    <select name="customer[country_id]" id="customer_country_id" class="yae-select">
                      <option value="">Select Country/Nation</option>
                      <optgroup label="Teyvat Nations">
                        <% Country.where(code: ['MD', 'LY', 'IZ', 'SM', 'FT', 'NT', 'SN', 'KH', 'NK']).each do |country| %>
                          <option value="<%= country.id %>" 
                                  data-code="<%= country.code %>"
                                  <%= 'selected' if @customer.country_id == country.id %>>
                            <%= country.name %>
                          </option>
                        <% end %>
                      </optgroup>
                      <optgroup label="Real World Countries">
                        <% Country.where.not(code: ['CA', 'MD', 'LY', 'IZ', 'SM', 'FT', 'NT', 'SN', 'KH', 'NK']).each do |country| %>
                          <option value="<%= country.id %>" 
                                  data-code="<%= country.code %>"
                                  <%= 'selected' if @customer.country_id == country.id %>>
                            <%= country.name %>
                          </option>
                        <% end %>
                      </optgroup>
                    </select>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="customer_postal_code" class="yae-label">
                    <span id="postal_code_label">Postal code</span>
                  </label>
                  <input type="text" name="customer[postal_code]" id="customer_postal_code" 
                         value="<%= @customer.postal_code %>" class="yae-input yae-input-postal" 
                         placeholder="A1A 1A1" maxlength="7">
                  <small class="yae-help-text">
                    <i class="bi bi-mailbox me-1"></i><span id="postal_code_format">Format: A1A 1A1</span>
                  </small>
                </div>

                <div class="mb-3">
                  <label for="customer_phone" class="yae-label">Phone Number (Optional)</label>
                  <input type="tel" name="customer[phone]" id="customer_phone" 
                         value="<%= @customer.phone %>" class="yae-input" placeholder="(204) 555-1234">
                  <small class="yae-help-text">
                    <i class="bi bi-telephone me-1"></i>Optional - for order updates
                  </small>
                </div>
              </div>

              <hr class="yae-section-divider">

              <!-- Change Password Section -->
              <div class="yae-form-section">
                <h5 class="yae-section-title">
                  <i class="bi bi-shield-lock me-2"></i> Change Password
                </h5>
                <p class="yae-section-description">
                  Leave password fields blank if you don't want to change your password.
                </p>
                
                <div class="mb-3">
                  <label for="customer_current_password" class="yae-label">Current Password</label>
                  <input type="password" name="customer[current_password]" id="customer_current_password" 
                         class="yae-input" placeholder="Enter your current password" autocomplete="off">
                  <small class="yae-help-text yae-help-text-important">
                    <i class="bi bi-key me-1"></i>Required only when changing password or email
                  </small>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="customer_password" class="yae-label">New Password (optional)</label>
                    <input type="password" name="customer[password]" id="customer_password" 
                           class="yae-input" placeholder="Enter new password" autocomplete="off">
                    <small class="yae-help-text">
                      <i class="bi bi-lock me-1"></i>Min. 6 characters
                    </small>
                  </div>
                  <div class="col-md-6">
                    <label for="customer_password_confirmation" class="yae-label">Confirm New Password</label>
                    <input type="password" name="customer[password_confirmation]" id="customer_password_confirmation" 
                           class="yae-input" placeholder="Confirm new password" autocomplete="off">
                  </div>
                </div>

                <div class="yae-info-box">
                  <i class="bi bi-exclamation-circle me-2"></i>
                  <strong>Note:</strong> You must enter your current password when changing your email address or password. For other profile updates (name, address, phone), current password is optional.
                </div>
              </div>

              <hr class="yae-section-divider">

              <!-- Action Buttons -->
              <div class="yae-form-actions">
                <%= link_to customer_profile_path, class: 'yae-btn yae-btn-secondary' do %>
                  <i class="bi bi-x-circle me-2"></i>Cancel
                <% end %>
                <button type="submit" class="yae-btn yae-btn-primary">
                  <i class="bi bi-check-circle me-2"></i>Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Auto-format postal code for Canada
document.addEventListener('DOMContentLoaded', function() {
  const postalInput = document.querySelector('input[name="customer[postal_code]"]');
  const canadaRadio = document.getElementById('canada_shipping');
  const teyvatRadio = document.getElementById('teyvat_shipping');
  const internationalRadio = document.getElementById('international_shipping');
  const provinceField = document.getElementById('province_field');
  const countryField = document.getElementById('country_field');
  const provinceSelect = document.getElementById('customer_province_id');
  const countrySelect = document.getElementById('customer_country_id');
  const countryLabel = document.getElementById('country_label');
  const postalCodeLabel = document.getElementById('postal_code_label');
  const postalCodeFormat = document.getElementById('postal_code_format');
  
  const teyvatCodes = ['MD', 'LY', 'IZ', 'SM', 'FT', 'NT', 'SN', 'KH', 'NK'];
  
  // Check if customer has Teyvat address on load
  <% if @customer.country_id.present? && ['MD', 'LY', 'IZ', 'SM', 'FT', 'NT', 'SN', 'KH', 'NK'].include?(@customer.country&.code) %>
    teyvatRadio.checked = true;
  <% end %>
  
  function toggleShippingRegion() {
    const isCanada = canadaRadio.checked;
    const isTeyvat = teyvatRadio.checked;
    
    if (isCanada) {
      provinceField.style.display = 'block';
      countryField.style.display = 'none';
      provinceSelect.disabled = false;
      countrySelect.disabled = true;
      countrySelect.value = '';
      postalCodeLabel.textContent = 'Postal code';
      postalInput.placeholder = 'A1A 1A1';
      postalCodeFormat.textContent = 'Format: A1A 1A1';
    } else if (isTeyvat) {
      provinceField.style.display = 'none';
      countryField.style.display = 'block';
      provinceSelect.disabled = true;
      provinceSelect.value = '';
      countrySelect.disabled = false;
      countryLabel.textContent = 'Teyvat Nation';
      postalCodeLabel.textContent = 'Region Code';
      postalInput.placeholder = 'Enter region code';
      postalCodeFormat.textContent = 'Enter your region code';
      filterCountryOptions('teyvat');
    } else {
      provinceField.style.display = 'none';
      countryField.style.display = 'block';
      provinceSelect.disabled = true;
      provinceSelect.value = '';
      countrySelect.disabled = false;
      countryLabel.textContent = 'Country';
      postalCodeLabel.textContent = 'Postal/Zip Code';
      postalInput.placeholder = 'Enter postal/zip code';
      postalCodeFormat.textContent = 'Enter your postal or zip code';
      filterCountryOptions('international');
    }
  }
  
  function filterCountryOptions(region) {
    const optgroups = countrySelect.querySelectorAll('optgroup');
    
    if (region === 'teyvat') {
      optgroups.forEach(optgroup => {
        if (optgroup.label === 'Teyvat Nations') {
          optgroup.style.display = 'block';
        } else {
          optgroup.style.display = 'none';
        }
      });
      
      const selectedOption = countrySelect.options[countrySelect.selectedIndex];
      if (selectedOption && selectedOption.dataset.code && !teyvatCodes.includes(selectedOption.dataset.code)) {
        countrySelect.value = '';
      }
    } else {
      optgroups.forEach(optgroup => {
        optgroup.style.display = 'block';
      });
    }
  }
  
  canadaRadio.addEventListener('change', toggleShippingRegion);
  teyvatRadio.addEventListener('change', toggleShippingRegion);
  internationalRadio.addEventListener('change', toggleShippingRegion);
  
  // Initialize on page load
  toggleShippingRegion();
  
  // Postal code formatting for Canada only
  if (postalInput) {
    postalInput.addEventListener('input', function(e) {
      if (canadaRadio.checked) {
        let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        
        if (value.length > 3) {
          value = value.slice(0, 3) + ' ' + value.slice(3, 6);
        }
        
        e.target.value = value;
      }
    });
  }
});
</script>

<style>
  :root {
    --yae-pink: #E91E8C;
    --yae-purple: #8B2C7F;
    --yae-dark: #4A1942;
    --yae-light-pink: #F8C8DC;
  }

  .yae-profile-page {
    background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
    min-height: 100vh;
    padding: 2rem 0;
  }

  .yae-breadcrumb {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
  }

  .yae-breadcrumb a {
    color: var(--yae-purple);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s ease;
  }

  .yae-breadcrumb a:hover {
    color: var(--yae-pink);
  }

  .yae-edit-card {
    background: white;
    border-radius: 25px;
    border: 3px solid var(--yae-purple);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .yae-card-header {
    background: linear-gradient(135deg, var(--yae-purple) 0%, var(--yae-dark) 100%);
    color: white;
    padding: 1.5rem 2rem;
    font-weight: 700;
  }

  .yae-card-body {
    padding: 2.5rem;
  }

  .yae-form-section {
    margin-bottom: 2rem;
  }

  .yae-section-title {
    color: var(--yae-purple);
    font-weight: 700;
    font-size: 1.4rem;
    margin-bottom: 1.5rem;
  }

  .yae-optional {
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 500;
  }

  .yae-section-description {
    color: #6b7280;
    font-size: 1rem;
    margin-bottom: 1.5rem;
  }

  .yae-section-divider {
    border: none;
    border-top: 3px solid #e9d5ff;
    margin: 2.5rem 0;
  }

  .yae-divider {
    border: none;
    border-top: 2px solid #e9d5ff;
    margin: 1.5rem 0;
  }

  .yae-label {
    color: var(--yae-dark);
    font-weight: 700;
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
    display: block;
  }

  .yae-input, .yae-select {
    width: 100%;
    padding: 0.85rem 1.25rem;
    border: 2px solid #e9d5ff;
    border-radius: 15px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
  }

  .yae-input:focus, .yae-select:focus {
    outline: none;
    border-color: var(--yae-purple);
    box-shadow: 0 0 0 3px rgba(139, 44, 127, 0.1);
  }

  .yae-input-postal {
    max-width: 200px;
  }

  .yae-help-text {
    color: #6b7280;
    font-size: 0.85rem;
    display: block;
    margin-top: 0.5rem;
  }

  .yae-help-text-important {
    color: var(--yae-purple);
    font-weight: 600;
  }

  /* Region Toggle */
  .country-toggle {
    background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
    padding: 1.5rem;
    border-radius: 20px;
    border: 2px solid #e9d5ff;
    margin-bottom: 2rem;
  }

  .country-toggle .form-label {
    color: var(--yae-purple);
    font-size: 1.1rem;
    font-weight: 700;
  }

  .btn-group-custom {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    width: 100%;
  }

  .btn-region {
    flex: 1;
    min-width: 150px;
    padding: 1rem 1.5rem;
    font-weight: 700;
    transition: all 0.3s ease;
    border-radius: 15px;
  }

  .country-toggle .btn-outline-primary {
    border: 2px solid #e9d5ff;
    color: var(--yae-purple);
    background: white;
  }

  .country-toggle .btn-check:checked + .btn-outline-primary {
    background: linear-gradient(135deg, var(--yae-purple) 0%, var(--yae-dark) 100%);
    border-color: var(--yae-purple);
    color: white;
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(139, 44, 127, 0.4);
  }

  .country-toggle .btn-outline-primary:hover {
    background: var(--yae-light-pink);
    border-color: var(--yae-purple);
    color: var(--yae-purple);
    transform: translateY(-2px);
  }

  #teyvat_shipping:checked + label {
    background: linear-gradient(135deg, #FFB142 0%, #E91E8C 100%) !important;
    border-color: #FFB142 !important;
  }

  .yae-file-input {
    padding: 0.75rem;
    border: 2px dashed #e9d5ff;
    border-radius: 15px;
    background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
    transition: all 0.3s ease;
    cursor: pointer;
    width: 100%;
  }

  .yae-file-input:hover {
    border-color: var(--yae-purple);
    background: white;
  }

  .yae-profile-picture-section {
    background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
    padding: 2rem;
    border-radius: 20px;
    margin-bottom: 1.5rem;
    border: 2px solid #e9d5ff;
  }

  .yae-current-avatar {
    border-radius: 50%;
    border: 3px solid var(--yae-purple);
    width: 80px;
    height: 80px;
    object-fit: cover;
  }

  .yae-info-box {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid #f59e0b;
    border-radius: 15px;
    padding: 1.25rem;
    color: #92400e;
    font-size: 0.95rem;
  }

  .yae-info-box strong {
    font-weight: 700;
  }

  .yae-alert {
    padding: 1.5rem;
    border-radius: 15px;
    margin-bottom: 2rem;
  }

  .yae-alert-danger {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border: 2px solid #dc2626;
    color: #991b1b;
  }

  .yae-alert-heading {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: #991b1b;
  }

  .yae-alert ul {
    padding-left: 1.5rem;
    margin-top: 0.75rem;
  }

  .yae-alert li {
    margin-bottom: 0.5rem;
  }

  .yae-btn {
    padding: 0.85rem 2rem;
    border-radius: 25px;
    font-weight: 700;
    text-decoration: none;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-family: inherit;
    line-height: 1.5;
  }

  .yae-btn-primary {
    background: linear-gradient(135deg, var(--yae-purple) 0%, var(--yae-dark) 100%);
    color: white;
  }

  .yae-btn-primary:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(139, 44, 127, 0.4);
  }

  .yae-btn-secondary {
    background: white;
    color: var(--yae-dark);
    border: 2px solid #e5e7eb;
  }

  .yae-btn-secondary:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
  }

  .yae-form-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    padding-top: 1rem;
  }

  @media (max-width: 767px) {
    .yae-card-body {
      padding: 1.5rem;
    }

    .yae-section-title {
      font-size: 1.2rem;
    }

    .yae-profile-picture-section {
      padding: 1.5rem;
    }

    .yae-form-actions {
      flex-direction: column-reverse;
    }

    .yae-form-actions .yae-btn {
      width: 100%;
    }

    .btn-group-custom {
      flex-direction: column;
    }
    
    .btn-region {
      width: 100%;
      min-width: unset;
    }
  }
</style>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">