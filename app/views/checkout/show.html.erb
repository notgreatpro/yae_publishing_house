<!-- app/views/checkout/show.html.erb -->
<!-- Feature 3.1.3 - Complete a checkout process (8%) -->
<!-- Feature 3.3.1 - Stripe Payment Integration (6%) -->
<!-- UPDATED: International Shipping Support -->

<div class="yae-checkout-page">
  <div class="container mt-4 mb-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb yae-breadcrumb">
        <li class="breadcrumb-item"><%= link_to 'Home', root_path %></li>
        <li class="breadcrumb-item"><%= link_to 'Cart', cart_path %></li>
        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
      </ol>
    </nav>

    <!-- Page Header -->
    <div class="yae-checkout-header">
      <h1 class="yae-checkout-title">
        <i class="bi bi-credit-card me-3"></i>Secure Checkout
      </h1>
      <div class="yae-security-badge">
        <i class="bi bi-shield-fill-check me-2"></i>
        <span>SSL Encrypted & Secure</span>
      </div>
    </div>

    <!-- Flash Messages -->
    <% if flash[:alert] %>
      <div class="yae-alert yae-alert-danger">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <%= flash[:alert] %>
        <button type="button" class="yae-alert-close" data-bs-dismiss="alert">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    <% end %>

    <% if @order && @order.errors.any? %>
      <div class="yae-alert yae-alert-danger">
        <h5 class="yae-alert-heading">
          <i class="bi bi-exclamation-circle me-2"></i>
          <%= pluralize(@order.errors.count, "error") %> prevented this order from being saved:
        </h5>
        <ul class="yae-error-list">
          <% @order.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="row g-4">
      <!-- Main Checkout Form -->
      <div class="col-lg-8">
        <%= form_with url: checkout_path, method: :post, local: true, id: 'checkout-form' do |f| %>
          
          <!-- Customer Information -->
          <div class="yae-checkout-section">
            <div class="yae-section-header">
              <h3 class="yae-section-title">
                <i class="bi bi-person-circle me-2"></i>Contact Information
              </h3>
            </div>
            <div class="yae-section-body">
              <div class="yae-info-display">
                <div class="yae-info-label">Logged in as:</div>
                <div class="yae-info-value">
                  <i class="bi bi-envelope-fill me-2"></i>
                  <%= @customer.email %>
                </div>
              </div>
            </div>
          </div>

          <!-- Shipping Address -->
          <div class="yae-checkout-section">
            <div class="yae-section-header">
              <h3 class="yae-section-title">
                <i class="bi bi-truck me-2"></i>Shipping Address
              </h3>
            </div>
            <div class="yae-section-body">
              
              <!-- Country/Region Selection Toggle -->
              <div class="country-toggle mb-4">
                <label class="form-label fw-bold">
                  <i class="bi bi-globe me-2"></i>Shipping Region
                </label>
                <div class="btn-group-custom" role="group">
                  <%= radio_button_tag :is_canada, '1', @customer.is_canada? || @customer.province_id.present?, 
                      class: 'btn-check', id: 'canada_shipping' %>
                  <label class="btn btn-outline-primary btn-region" for="canada_shipping">
                    <i class="bi bi-flag me-2"></i>Canada
                  </label>
                  
                  <%= radio_button_tag :is_canada, '0', false, class: 'btn-check', id: 'teyvat_shipping', data: { region: 'teyvat' } %>
                  <label class="btn btn-outline-primary btn-region" for="teyvat_shipping">
                    <i class="bi bi-stars me-2"></i>Teyvat
                  </label>
                  
                  <%= radio_button_tag :is_canada, '0', !@customer.is_canada? && @customer.country_id.present?, 
                      class: 'btn-check', id: 'international_shipping', data: { region: 'international' } %>
                  <label class="btn btn-outline-primary btn-region" for="international_shipping">
                    <i class="bi bi-airplane me-2"></i>International
                  </label>
                </div>
              </div>

              <% if @customer.has_complete_address? %>
                <div class="yae-address-options">
                  <div class="yae-address-option">
                    <%= radio_button_tag :use_saved_address, '1', true, class: 'yae-radio-input', id: 'use_saved_yes' %>
                    <label class="yae-address-label" for="use_saved_yes">
                      <div class="yae-option-header">
                        <i class="bi bi-bookmark-check-fill me-2"></i>
                        <strong>Use saved address</strong>
                      </div>
                      <div class="yae-saved-address">
                        <p class="mb-1"><i class="bi bi-person me-2"></i><%= @customer.first_name %> <%= @customer.last_name %></p>
                        <p class="mb-1"><i class="bi bi-geo-alt me-2"></i><%= @customer.address_line1 %></p>
                        <% if @customer.address_line2.present? %>
                          <p class="mb-1 ms-4"><%= @customer.address_line2 %></p>
                        <% end %>
                        <p class="mb-1 ms-4">
                          <%= @customer.city %>, 
                          <%= @customer.province&.code || @customer.country&.name %>
                          <%= @customer.postal_code %>
                        </p>
                      </div>
                    </label>
                  </div>

                  <div class="yae-address-option">
                    <%= radio_button_tag :use_saved_address, '0', false, class: 'yae-radio-input', id: 'use_saved_no' %>
                    <label class="yae-address-label" for="use_saved_no">
                      <i class="bi bi-plus-circle-fill me-2"></i>
                      <strong>Use a different address</strong>
                    </label>
                  </div>
                </div>

                <div id="new-address-fields" style="display: none;">
              <% else %>
                <div id="new-address-fields">
              <% end %>

                  <div class="yae-form-section">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="first_name" class="yae-form-label">
                          <i class="bi bi-person me-1"></i>First Name
                        </label>
                        <%= text_field_tag :first_name, @customer.first_name, 
                            required: !@customer.has_complete_address?, 
                            class: 'yae-form-input',
                            placeholder: 'John' %>
                      </div>
                      
                      <div class="col-md-6">
                        <label for="last_name" class="yae-form-label">
                          <i class="bi bi-person me-1"></i>Last Name
                        </label>
                        <%= text_field_tag :last_name, @customer.last_name, 
                            required: !@customer.has_complete_address?, 
                            class: 'yae-form-input',
                            placeholder: 'Doe' %>
                      </div>
                    </div>

                    <div class="mt-3">
                      <label for="address_line1" class="yae-form-label">
                        <i class="bi bi-house-door me-1"></i>Address Line 1
                      </label>
                      <%= text_field_tag :address_line1, '', 
                          required: !@customer.has_complete_address?, 
                          class: 'yae-form-input',
                          placeholder: 'Street address, P.O. box' %>
                    </div>

                    <div class="mt-3">
                      <label for="address_line2" class="yae-form-label">
                        <i class="bi bi-building me-1"></i>Address Line 2 (Optional)
                      </label>
                      <%= text_field_tag :address_line2, '', 
                          class: 'yae-form-input',
                          placeholder: 'Apartment, suite, unit, building, floor, etc.' %>
                    </div>

                    <div class="row g-3 mt-1">
                      <div class="col-md-6">
                        <label for="city" class="yae-form-label">
                          <i class="bi bi-pin-map me-1"></i>City
                        </label>
                        <%= text_field_tag :city, '', 
                            required: !@customer.has_complete_address?, 
                            class: 'yae-form-input',
                            placeholder: 'Toronto' %>
                      </div>

                      <!-- Canadian Province (shown when Canada is selected) -->
                      <div class="col-md-6" id="province_field">
                        <label for="province_id" class="yae-form-label">
                          <i class="bi bi-map me-1"></i>Province
                        </label>
                        <%= select_tag :province_id, 
                            options_from_collection_for_select(@provinces, :id, :name, @customer.province_id),
                            prompt: 'Select Province',
                            required: true,
                            class: 'yae-form-select',
                            id: 'province-select',
                            data: { 
                              provinces: @provinces.to_json(only: [:id, :name, :gst_rate, :pst_rate, :hst_rate]),
                              subtotal: @subtotal_after_discount
                            } %>
                      </div>

                      <!-- International Country (shown when International/Teyvat is selected) -->
                      <div class="col-md-6" id="country_field" style="display: none;">
                        <label for="country_id" class="yae-form-label">
                          <i class="bi bi-globe me-1"></i>
                          <span id="country_label">Country</span>
                        </label>
                        <%= select_tag :country_id,
                            grouped_options_for_select(
                              {
                                'Teyvat Nations' => @countries.where(code: ['MD', 'LY', 'IZ', 'SM', 'FT', 'NT', 'SN', 'KH', 'NK']).map { |c| [c.name, c.id] },
                                'Real World Countries' => @countries.where.not(code: ['CA', 'MD', 'LY', 'IZ', 'SM', 'FT', 'NT', 'SN', 'KH', 'NK']).map { |c| [c.name, c.id] }
                              },
                              @customer.country_id
                            ),
                            prompt: 'Select Country/Nation',
                            class: 'yae-form-select',
                            required: false,
                            id: 'country-select',
                            data: {
                              countries: @countries.where.not(code: 'CA').to_json(only: [:id, :name, :code, :tax_rate, :tax_name])
                            } %>
                      </div>
                    </div>

                    <div class="row g-3 mt-1">
                      <div class="col-md-6">
                        <label for="postal_code" class="yae-form-label">
                          <i class="bi bi-mailbox me-1"></i>
                          <span id="postal_code_label">Postal Code</span>
                        </label>
                        <%= text_field_tag :postal_code, '', 
                            required: !@customer.has_complete_address?, 
                            class: 'yae-form-input',
                            placeholder: 'A1A 1A1',
                            id: 'postal-code-input' %>
                      </div>

                      <div class="col-md-6">
                        <label for="phone" class="yae-form-label">
                          <i class="bi bi-telephone me-1"></i>Phone Number (Optional)
                        </label>
                        <%= telephone_field_tag :phone, '', 
                            class: 'yae-form-input',
                            placeholder: '(123) 456-7890' %>
                      </div>
                    </div>

                    <!-- Tax Information Display -->
                    <div class="alert alert-info mt-4" id="tax_info">
                      <i class="bi bi-info-circle me-2"></i>
                      <span id="tax_message">
                        Select your province to see applicable taxes
                      </span>
                    </div>
                  </div>
                </div>
            </div>
          </div>

          <!-- Payment Information -->
          <div class="yae-checkout-section">
            <div class="yae-section-header">
              <h3 class="yae-section-title">
                <i class="bi bi-credit-card-2-front me-2"></i>Payment Information
              </h3>
            </div>
            <div class="yae-section-body">
              <div class="yae-secure-notice">
                <i class="bi bi-shield-lock-fill me-2"></i>
                <div>
                  <strong>Secure Payment</strong>
                  <p class="mb-0">Your payment information is encrypted and secure</p>
                </div>
              </div>

              <div class="yae-form-section">
                <div class="mt-3">
                  <label for="cardholder_name" class="yae-form-label">
                    <i class="bi bi-person-badge me-1"></i>Cardholder Name
                  </label>
                  <%= text_field_tag :cardholder_name, '', 
                      required: true,
                      class: 'yae-form-input',
                      placeholder: 'Name on card',
                      autocomplete: 'cc-name' %>
                </div>

                <div class="mt-3">
                  <label for="card-number-element" class="yae-form-label">
                    <i class="bi bi-credit-card me-1"></i>Card Number
                  </label>
                  <div id="card-number-element" class="yae-stripe-element"></div>
                </div>

                <div class="row g-3 mt-1">
                  <div class="col-md-6">
                    <label for="card-expiry-element" class="yae-form-label">
                      <i class="bi bi-calendar-event me-1"></i>Expiry Date
                    </label>
                    <div id="card-expiry-element" class="yae-stripe-element"></div>
                  </div>

                  <div class="col-md-6">
                    <label for="card-cvc-element" class="yae-form-label">
                      <i class="bi bi-lock me-1"></i>CVC
                    </label>
                    <div id="card-cvc-element" class="yae-stripe-element"></div>
                  </div>
                </div>

                <div id="card-errors" role="alert" class="yae-card-error"></div>

                <div class="yae-test-mode-notice">
                  <div class="yae-test-header">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    <strong>Test Mode</strong>
                  </div>
                  <p class="mb-1">Use test card: <code class="yae-test-code">4242 4242 4242 4242</code></p>
                  <p class="mb-0">Any future expiry date and any 3-digit CVC</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Order Notes -->
          <div class="yae-checkout-section">
            <div class="yae-section-header">
              <h3 class="yae-section-title">
                <i class="bi bi-chat-left-text me-2"></i>Order Notes (Optional)
              </h3>
            </div>
            <div class="yae-section-body">
              <label for="order_notes" class="yae-form-label">
                <i class="bi bi-pencil me-1"></i>Special instructions or delivery notes
              </label>
              <%= text_area_tag :order_notes, '', 
                  class: 'yae-form-textarea',
                  rows: 4,
                  placeholder: 'Any special delivery instructions...' %>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="yae-checkout-actions">
            <%= link_to cart_path, class: 'btn yae-back-btn' do %>
              <i class="bi bi-arrow-left me-2"></i>Return to Cart
            <% end %>
            <%= f.submit 'Place Order', class: 'btn yae-place-order-btn', id: 'submit-button', 
                data: { disable_with: 'Processing Payment...' } %>
          </div>

          <%= hidden_field_tag :stripe_payment_method_id, '', id: 'stripe-payment-method-id' %>
        <% end %>
      </div>

      <!-- Order Summary Sidebar -->
      <div class="col-lg-4">
        <div class="yae-order-summary-checkout">
          <div class="yae-summary-header">
            <h3 class="yae-summary-title">
              <i class="bi bi-receipt me-2"></i>Order Summary
            </h3>
          </div>
          
          <div class="yae-summary-body-checkout">
            <!-- Cart Items -->
            <div class="yae-summary-items">
              <% @cart_items.each do |item| %>
                <div class="yae-summary-item">
                  <div class="yae-item-image">
                    <% if item[:product].cover_image.attached? %>
                      <%= image_tag item[:product].cover_image, alt: item[:product].title %>
                    <% else %>
                      <div class="yae-item-placeholder">
                        <i class="bi bi-book"></i>
                      </div>
                    <% end %>
                  </div>
                  <div class="yae-item-details">
                    <p class="yae-item-title"><%= truncate(item[:product].title, length: 40) %></p>
                    <p class="yae-item-meta">Qty: <%= item[:quantity] %></p>
                    <p class="yae-item-price"><%= number_to_currency(item[:product].current_price) %> each</p>
                  </div>
                  <div class="yae-item-total">
                    <%= number_to_currency(item[:product].current_price * item[:quantity]) %>
                  </div>
                </div>
              <% end %>
            </div>

            <!-- Summary Calculations -->
            <div class="yae-summary-calculations">
              <div class="yae-calc-row">
                <span>Subtotal (<%= pluralize(@cart_items.sum { |i| i[:quantity] }, 'item') %>):</span>
                <strong><%= number_to_currency(@subtotal) %></strong>
              </div>
              
              <% if @coupon && @discount > 0 %>
                <div class="yae-calc-row yae-discount-row-checkout">
                  <span>
                    <i class="bi bi-tag-fill me-1"></i>Discount (<%= @coupon.code %>):
                  </span>
                  <span class="yae-discount-amount-checkout">-<%= number_to_currency(@discount) %></span>
                </div>
                
                <div class="yae-calc-row">
                  <span>Subtotal after discount:</span>
                  <strong><%= number_to_currency(@subtotal_after_discount) %></strong>
                </div>
              <% end %>
              
              <div class="yae-calc-row tax-row">
                <span>
                  <i class="bi bi-receipt-cutoff me-1"></i>Tax:
                </span>
                <span id="tax-display" class="yae-tax-value">Select province/country</span>
              </div>

              <div class="yae-calc-total">
                <span>Total:</span>
                <span id="total-display" class="yae-total-value"><%= number_to_currency(@subtotal_after_discount) %>+</span>
              </div>
              
              <p class="yae-calc-note">
                <i class="bi bi-info-circle me-1"></i>
                Final amount calculated after selecting location
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://js.stripe.com/v3/"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const stripeKey = '<%= Rails.configuration.stripe[:publishable_key].to_s %>';
    
    if (!stripeKey || stripeKey === '') {
      console.error('Stripe publishable key not found!');
      return;
    }
    
    const stripe = Stripe(stripeKey);
    const elements = stripe.elements();
    
    const cardNumberElement = elements.create('cardNumber', {
      style: {
        base: {
          fontSize: '16px',
          color: '#212529',
          '::placeholder': { color: '#6c757d' }
        },
        invalid: { color: '#dc3545' }
      }
    });
    
    const cardExpiryElement = elements.create('cardExpiry', {
      style: {
        base: {
          fontSize: '16px',
          color: '#212529',
          '::placeholder': { color: '#6c757d' }
        },
        invalid: { color: '#dc3545' }
      }
    });
    
    const cardCvcElement = elements.create('cardCvc', {
      style: {
        base: {
          fontSize: '16px',
          color: '#212529',
          '::placeholder': { color: '#6c757d' }
        },
        invalid: { color: '#dc3545' }
      }
    });
    
    cardNumberElement.mount('#card-number-element');
    cardExpiryElement.mount('#card-expiry-element');
    cardCvcElement.mount('#card-cvc-element');
    
    const displayError = document.getElementById('card-errors');
    
    [cardNumberElement, cardExpiryElement, cardCvcElement].forEach(element => {
      element.on('change', function(event) {
        displayError.textContent = event.error ? event.error.message : '';
      });
    });
    
    const form = document.getElementById('checkout-form');
    const submitButton = document.getElementById('submit-button');
    
    form.addEventListener('submit', async function(event) {
      event.preventDefault();
      submitButton.disabled = true;
      
      const cardholderName = document.getElementById('cardholder_name').value;
      
      if (!cardholderName) {
        displayError.textContent = 'Please enter the cardholder name';
        submitButton.disabled = false;
        return;
      }
      
      const {error, paymentMethod} = await stripe.createPaymentMethod({
        type: 'card',
        card: cardNumberElement,
        billing_details: { name: cardholderName }
      });
      
      if (error) {
        displayError.textContent = error.message;
        submitButton.disabled = false;
      } else {
        document.getElementById('stripe-payment-method-id').value = paymentMethod.id;
        HTMLFormElement.prototype.submit.call(form);
      }
    });
    
    // Handle saved address radio buttons
    const radios = document.querySelectorAll('input[name="use_saved_address"]');
    const newAddressFields = document.getElementById('new-address-fields');
    
    if (radios.length > 0 && newAddressFields) {
      radios.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === '0') {
            newAddressFields.style.display = 'block';
            newAddressFields.querySelectorAll('input[required], select[required]').forEach(field => {
              field.required = true;
            });
          } else {
            newAddressFields.style.display = 'none';
            newAddressFields.querySelectorAll('input, select').forEach(field => {
              field.required = false;
            });
          }
        });
      });
    }
    
    // ========================================
    // INTERNATIONAL SHIPPING TOGGLE LOGIC
    // ========================================
    const canadaRadio = document.getElementById('canada_shipping');
    const teyvatRadio = document.getElementById('teyvat_shipping');
    const internationalRadio = document.getElementById('international_shipping');
    const provinceField = document.getElementById('province_field');
    const countryField = document.getElementById('country_field');
    const provinceSelect = document.getElementById('province-select');
    const countrySelect = document.getElementById('country-select');
    const countryLabel = document.getElementById('country_label');
    const postalCodeLabel = document.getElementById('postal_code_label');
    const postalCodeInput = document.getElementById('postal-code-input');
    const taxMessage = document.getElementById('tax_message');

    // Tax rates data from backend
    const provinceTaxes = JSON.parse(provinceSelect.dataset.provinces);
    const countryTaxes = JSON.parse(countrySelect.dataset.countries);
    const subtotal = <%= @subtotal_after_discount %>;

    // Teyvat nation codes
    const teyvatCodes = ['MD', 'LY', 'IZ', 'SM', 'FT', 'NT', 'SN', 'KH', 'NK'];

    // Toggle between Canada, Teyvat, and International
    function toggleShippingRegion() {
      const isCanada = canadaRadio.checked;
      const isTeyvat = teyvatRadio.checked;
      
      if (isCanada) {
        provinceField.style.display = 'block';
        countryField.style.display = 'none';
        provinceSelect.required = true;
        countrySelect.required = false;
        postalCodeLabel.textContent = 'Postal Code';
        postalCodeInput.placeholder = 'A1A 1A1';
        updateTaxInfo('province');
      } else if (isTeyvat) {
        provinceField.style.display = 'none';
        countryField.style.display = 'block';
        provinceSelect.required = false;
        countrySelect.required = true;
        countryLabel.textContent = 'Teyvat Nation';
        postalCodeLabel.textContent = 'Region Code';
        postalCodeInput.placeholder = 'Enter region code';
        
        // Filter country select to show only Teyvat nations
        filterCountryOptions('teyvat');
        updateTaxInfo('country');
      } else {
        provinceField.style.display = 'none';
        countryField.style.display = 'block';
        provinceSelect.required = false;
        countrySelect.required = true;
        countryLabel.textContent = 'Country';
        postalCodeLabel.textContent = 'Postal/Zip Code';
        postalCodeInput.placeholder = 'Enter postal/zip code';
        
        // Show all countries
        filterCountryOptions('international');
        updateTaxInfo('country');
      }
    }

    // Filter country options based on region
    function filterCountryOptions(region) {
      const optgroups = countrySelect.querySelectorAll('optgroup');
      
      if (region === 'teyvat') {
        // Show only Teyvat Nations optgroup
        optgroups.forEach(optgroup => {
          if (optgroup.label === 'Teyvat Nations') {
            optgroup.style.display = 'block';
          } else {
            optgroup.style.display = 'none';
          }
        });
        // Reset selection if not a Teyvat nation
        const selectedCountry = countryTaxes.find(c => c.id === parseInt(countrySelect.value));
        if (selectedCountry && !teyvatCodes.includes(selectedCountry.code)) {
          countrySelect.value = '';
        }
      } else {
        // Show all optgroups
        optgroups.forEach(optgroup => {
          optgroup.style.display = 'block';
        });
      }
    }

    // Update tax information display
    function updateTaxInfo(type) {
      if (type === 'province') {
        const selectedProvinceId = parseInt(provinceSelect.value);
        const province = provinceTaxes.find(p => p.id === selectedProvinceId);
        
        if (province) {
          let taxDetails = [];
          if (province.hst_rate > 0) {
            taxDetails.push(`HST: ${province.hst_rate}%`);
          } else {
            if (province.gst_rate > 0) taxDetails.push(`GST: ${province.gst_rate}%`);
            if (province.pst_rate > 0) taxDetails.push(`PST: ${province.pst_rate}%`);
          }
          
          const totalRate = province.hst_rate || (province.gst_rate + province.pst_rate);
          const totalTax = subtotal * (totalRate / 100);
          const total = subtotal + totalTax;
          
          taxMessage.innerHTML = `<strong>${province.name}:</strong> ${taxDetails.join(', ')} = <strong>${totalRate}% total tax</strong>`;
          document.getElementById('tax-display').textContent = formatCurrency(totalTax);
          document.getElementById('total-display').textContent = formatCurrency(total);
        } else {
          taxMessage.textContent = 'Select your province to see applicable taxes';
          document.getElementById('tax-display').textContent = 'Select province';
          document.getElementById('total-display').textContent = formatCurrency(subtotal) + '+';
        }
      } else {
        const selectedCountryId = parseInt(countrySelect.value);
        const country = countryTaxes.find(c => c.id === selectedCountryId);
        
        if (country) {
          const isTeyvat = teyvatCodes.includes(country.code);
          const icon = isTeyvat ? 'âš¡' : 'ðŸŒ';
          
          if (country.tax_rate > 0) {
            const totalTax = subtotal * (country.tax_rate / 100);
            const total = subtotal + totalTax;
            
            taxMessage.innerHTML = `${icon} <strong>${country.name}:</strong> ${country.tax_name} <strong>${country.tax_rate}%</strong>`;
            document.getElementById('tax-display').textContent = formatCurrency(totalTax);
            document.getElementById('total-display').textContent = formatCurrency(total);
          } else {
            taxMessage.innerHTML = `${icon} <strong>${country.name}:</strong> ${country.tax_name || 'No additional taxes'}`;
            document.getElementById('tax-display').textContent = formatCurrency(0);
            document.getElementById('total-display').textContent = formatCurrency(subtotal);
          }
        } else {
          const regionText = teyvatRadio.checked ? 'Select your nation to see applicable taxes' : 'Select your country to see applicable taxes';
          taxMessage.textContent = regionText;
          document.getElementById('tax-display').textContent = 'Select location';
          document.getElementById('total-display').textContent = formatCurrency(subtotal) + '+';
        }
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-CA', {
        style: 'currency',
        currency: 'CAD'
      }).format(amount);
    }

    // Event listeners
    canadaRadio.addEventListener('change', toggleShippingRegion);
    teyvatRadio.addEventListener('change', toggleShippingRegion);
    internationalRadio.addEventListener('change', toggleShippingRegion);
    provinceSelect.addEventListener('change', () => updateTaxInfo('province'));
    countrySelect.addEventListener('change', () => updateTaxInfo('country'));

    // Initialize on page load
    toggleShippingRegion();
    
    // Set initial tax if province is already selected
    if (provinceSelect.value) {
      updateTaxInfo('province');
    }
  });
</script>
<style>
  :root {
    --yae-pink: #E91E8C;
    --yae-purple: #8B2C7F;
    --yae-dark: #4A1942;
    --yae-light-pink: #F8C8DC;
  }

  .yae-checkout-page {
    background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
    min-height: 100vh;
    padding-bottom: 3rem;
  }

  .yae-checkout-page .container {
    padding-top: 1.5rem;
    margin-top: 0 !important;
  }

  /* Breadcrumb */
  .yae-breadcrumb {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
    border: 2px solid #e9d5ff;
  }

  .yae-breadcrumb-item {
    font-weight: 600;
  }

  .yae-breadcrumb a {
    color: var(--yae-purple);
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .yae-breadcrumb a:hover {
    color: var(--yae-pink);
  }

  .yae-breadcrumb-item + .yae-breadcrumb-item::before {
    content: "/";
    padding: 0 0.5rem;
    color: #d1d5db;
  }

  .yae-breadcrumb-item.active {
    color: var(--yae-dark);
    font-weight: 700;
  }

  /* Checkout Header */
  .yae-checkout-header {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    border: 3px solid var(--yae-purple);
    position: relative;
    overflow: hidden;
  }

  .yae-checkout-header::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--yae-pink) 0%, var(--yae-purple) 50%, var(--yae-pink) 100%);
  }

  .yae-checkout-title {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--yae-pink) 0%, var(--yae-purple) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0;
    display: flex;
    align-items: center;
  }

  .yae-security-badge {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-weight: 700;
    display: flex;
    align-items: center;
    border: 2px solid #10b981;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
  }

  /* Alert styling */
  .yae-alert {
    padding: 1.25rem 1.5rem;
    border-radius: 15px;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
    position: relative;
  }

  .yae-alert-danger {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border: 2px solid #dc2626;
    color: #991b1b;
  }

  .yae-alert-heading {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
  }

  .yae-error-list {
    margin: 0.5rem 0 0 1.5rem;
    padding: 0;
  }

  .yae-error-list li {
    margin-bottom: 0.5rem;
  }

  .yae-alert-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    font-size: 1.2rem;
    opacity: 0.7;
    transition: opacity 0.3s ease;
  }

  .yae-alert-close:hover {
    opacity: 1;
  }

  /* Country Toggle Buttons */
  .country-toggle {
    margin-bottom: 2rem;
    background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
    padding: 1.5rem;
    border-radius: 20px;
    border: 2px solid #e9d5ff;
  }

  .country-toggle .form-label {
    color: var(--yae-purple);
    font-size: 1.1rem;
    font-weight: 700;
  }

  .btn-group-custom {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    width: 100%;
  }

  .btn-region {
    flex: 1;
    min-width: 150px;
    padding: 1rem 1.5rem;
    font-weight: 700;
    transition: all 0.3s ease;
    border-radius: 15px;
  }

  .country-toggle .btn-outline-primary {
    border: 2px solid #e9d5ff;
    color: var(--yae-purple);
    background: white;
  }

  .country-toggle .btn-check:checked + .btn-outline-primary {
    background: linear-gradient(135deg, var(--yae-purple) 0%, var(--yae-dark) 100%);
    border-color: var(--yae-purple);
    color: white;
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(139, 44, 127, 0.4);
  }

  .country-toggle .btn-outline-primary:hover {
    background: var(--yae-light-pink);
    border-color: var(--yae-purple);
    color: var(--yae-purple);
    transform: translateY(-2px);
  }

  /* Teyvat-themed styling for Teyvat button when selected */
  #teyvat_shipping:checked + label {
    background: linear-gradient(135deg, #FFB142 0%, #E91E8C 100%) !important;
    border-color: #FFB142 !important;
  }

  /* Tax info alert */
  #tax_info {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid #f59e0b;
    border-radius: 15px;
    padding: 1.25rem;
    font-size: 1rem;
  }

  #tax_message {
    color: #92400e;
    font-weight: 600;
  }

  /* Form styling to match edit profile */
  .yae-form-label {
    color: var(--yae-dark);
    font-weight: 700;
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
    display: block;
  }

  .yae-form-input, .yae-form-select, .yae-form-textarea {
    width: 100%;
    padding: 0.85rem 1.25rem;
    border: 2px solid #e9d5ff;
    border-radius: 15px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
  }

  .yae-form-input:focus, .yae-form-select:focus, .yae-form-textarea:focus {
    outline: none;
    border-color: var(--yae-purple);
    box-shadow: 0 0 0 3px rgba(139, 44, 127, 0.1);
  }

  .yae-form-textarea {
    resize: vertical;
    font-family: inherit;
  }

  /* Section styling */
  .yae-checkout-section {
    background: white;
    border-radius: 20px;
    border: 2px solid #e9d5ff;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .yae-section-header {
    background: linear-gradient(135deg, var(--yae-purple) 0%, var(--yae-dark) 100%);
    padding: 1.25rem 1.75rem;
  }

  .yae-section-title {
    color: white;
    font-weight: 700;
    font-size: 1.3rem;
    margin: 0;
  }

  .yae-section-body {
    padding: 2rem;
  }

  /* Address options styling */
  .yae-address-options {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .yae-address-option {
    position: relative;
  }

  .yae-radio-input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
  }

  .yae-address-label {
    display: block;
    padding: 1.5rem;
    border: 2px solid #e9d5ff;
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
  }

  .yae-radio-input:checked + .yae-address-label {
    border-color: var(--yae-purple);
    background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
    box-shadow: 0 4px 15px rgba(139, 44, 127, 0.2);
  }

  .yae-address-label:hover {
    border-color: var(--yae-purple);
    transform: translateY(-2px);
  }

  .yae-option-header {
    color: var(--yae-purple);
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
  }

  .yae-saved-address {
    color: var(--yae-dark);
    padding-left: 0.5rem;
  }

  /* Info display */
  .yae-info-display {
    background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
    padding: 1.25rem;
    border-radius: 15px;
    border: 2px solid #e9d5ff;
  }

  .yae-info-label {
    color: var(--yae-dark);
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .yae-info-value {
    color: var(--yae-purple);
    font-weight: 600;
    font-size: 1.1rem;
  }

  /* Secure notice */
  .yae-secure-notice {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    padding: 1.25rem;
    border-radius: 15px;
    border: 2px solid #10b981;
    margin-bottom: 1.5rem;
    color: #065f46;
  }

  .yae-secure-notice strong {
    font-size: 1.1rem;
  }

  /* Stripe elements */
  .yae-stripe-element {
    padding: 0.85rem 1.25rem;
    border: 2px solid #e9d5ff;
    border-radius: 15px;
    background: white;
    transition: all 0.3s ease;
  }

  .yae-stripe-element:focus-within {
    border-color: var(--yae-purple);
    box-shadow: 0 0 0 3px rgba(139, 44, 127, 0.1);
  }

  .yae-card-error {
    color: #dc2626;
    font-size: 0.9rem;
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: 10px;
    background: #fee2e2;
    border: 1px solid #fca5a5;
    display: none;
  }

  .yae-card-error:not(:empty) {
    display: block;
  }

  /* Test mode notice */
  .yae-test-mode-notice {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid #f59e0b;
    border-radius: 15px;
    padding: 1.25rem;
    margin-top: 1.5rem;
  }

  .yae-test-header {
    color: #92400e;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
  }

  .yae-test-mode-notice p {
    color: #92400e;
    margin-bottom: 0.25rem;
  }

  .yae-test-code {
    background: white;
    padding: 0.25rem 0.5rem;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-weight: 700;
    color: var(--yae-purple);
  }

  /* Checkout actions */
  .yae-checkout-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
  }

  .yae-back-btn {
    background: white;
    color: var(--yae-dark);
    border: 2px solid #e5e7eb;
    padding: 0.85rem 2rem;
    border-radius: 25px;
    font-weight: 700;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .yae-back-btn:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    transform: translateY(-2px);
  }

  .yae-place-order-btn {
    background: linear-gradient(135deg, var(--yae-purple) 0%, var(--yae-dark) 100%);
    color: white;
    padding: 0.85rem 2.5rem;
    border-radius: 25px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .yae-place-order-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(139, 44, 127, 0.4);
  }

  .yae-place-order-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  /* Order Summary Sidebar */
  .yae-order-summary-checkout {
    background: white;
    border-radius: 20px;
    border: 3px solid var(--yae-purple);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 110px;
  }

  .yae-summary-header {
    background: linear-gradient(135deg, var(--yae-purple) 0%, var(--yae-dark) 100%);
    padding: 1.5rem 2rem;
    border-radius: 17px 17px 0 0;
  }

  .yae-summary-title {
    color: white;
    font-weight: 700;
    font-size: 1.4rem;
    margin: 0;
  }

  .yae-summary-body-checkout {
    padding: 2rem;
  }

  /* Cart Items in Summary */
  .yae-summary-items {
    margin-bottom: 2rem;
  }

  .yae-summary-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
    border-radius: 15px;
    margin-bottom: 1rem;
    border: 2px solid #e9d5ff;
  }

  .yae-item-image {
    width: 60px;
    height: 80px;
    flex-shrink: 0;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid var(--yae-purple);
  }

  .yae-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .yae-item-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    color: var(--yae-purple);
    font-size: 1.5rem;
  }

  .yae-item-details {
    flex: 1;
    min-width: 0;
  }

  .yae-item-title {
    font-weight: 700;
    color: var(--yae-dark);
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
  }

  .yae-item-meta {
    color: #6b7280;
    font-size: 0.85rem;
    margin: 0 0 0.25rem 0;
  }

  .yae-item-price {
    color: var(--yae-purple);
    font-size: 0.85rem;
    margin: 0;
  }

  .yae-item-total {
    font-weight: 700;
    color: var(--yae-purple);
    font-size: 1.1rem;
    display: flex;
    align-items: center;
  }

  /* Summary Calculations */
  .yae-summary-calculations {
    border-top: 3px solid #e9d5ff;
    padding-top: 1.5rem;
  }

  .yae-calc-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    color: var(--yae-dark);
    font-size: 1rem;
  }

  .yae-calc-row strong {
    font-weight: 700;
  }

  .yae-discount-row-checkout {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    border-radius: 10px;
    padding: 0.75rem 1rem;
    margin: 0.5rem 0;
    border: 2px solid #10b981;
  }

  .yae-discount-amount-checkout {
    color: #065f46;
    font-weight: 700;
  }

  .tax-row {
    border-top: 2px solid #e9d5ff;
    margin-top: 0.5rem;
  }

  .yae-tax-value {
    font-weight: 700;
    color: var(--yae-purple);
  }

  .yae-calc-total {
    background: linear-gradient(135deg, var(--yae-purple) 0%, var(--yae-dark) 100%);
    color: white;
    padding: 1.25rem;
    border-radius: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    font-size: 1.3rem;
    font-weight: 700;
  }

  .yae-total-value {
    font-size: 1.5rem;
  }

  .yae-calc-note {
    text-align: center;
    color: #6b7280;
    font-size: 0.85rem;
    margin-top: 1rem;
    margin-bottom: 0;
  }

  /* Responsive adjustments */
  @media (max-width: 767px) {
    .btn-group-custom {
      flex-direction: column;
    }
    
    .btn-region {
      width: 100%;
      min-width: unset;
    }

    .yae-section-body {
      padding: 1.5rem;
    }

    .yae-checkout-actions {
      flex-direction: column-reverse;
    }

    .yae-checkout-actions .btn {
      width: 100%;
    }

    .yae-order-summary-checkout {
      position: static;
      margin-top: 2rem;
    }

    .yae-summary-body-checkout {
      padding: 1.5rem;
    }
  }
</style>
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">