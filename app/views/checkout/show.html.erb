<!-- app/views/checkout/show.html.erb -->
<!-- Feature 3.1.3 - Complete a checkout process (8%) -->
<!-- Feature 3.3.1 - Stripe Payment Integration (6%) -->

<div class="container mt-4 mb-5">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to 'Home', root_path %></li>
      <li class="breadcrumb-item"><%= link_to 'Cart', cart_path %></li>
      <li class="breadcrumb-item active" aria-current="page">Checkout</li>
    </ol>
  </nav>

  <div class="text-center py-4 mb-4 border-bottom">
    <h1 class="display-4">Checkout</h1>
  </div>

  <% if flash[:alert] %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <%= flash[:alert] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <% if @order && @order.errors.any? %>
    <div class="alert alert-danger">
      <h5 class="alert-heading"><%= pluralize(@order.errors.count, "error") %> prevented this order from being saved:</h5>
      <ul class="mb-0">
        <% @order.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <!-- Main Checkout Form -->
    <div class="col-lg-8 mb-4">
      <%= form_with url: checkout_path, method: :post, local: true, id: 'checkout-form' do |f| %>
        
        <!-- Customer Information -->
        <div class="card mb-4">
          <div class="card-header bg-white">
            <h3 class="h5 mb-0">Contact Information</h3>
          </div>
          <div class="card-body">
            <div class="alert alert-success mb-0">
              <strong>Logged in as:</strong> <%= @customer.email %>
            </div>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="card mb-4">
          <div class="card-header bg-white">
            <h3 class="h5 mb-0">Shipping Address</h3>
          </div>
          <div class="card-body">
            <% if @customer.has_complete_address? %>
              <div class="mb-3">
                <div class="form-check border rounded p-3 mb-2">
                  <%= radio_button_tag :use_saved_address, '1', true, class: 'form-check-input', id: 'use_saved_yes' %>
                  <label class="form-check-label w-100" for="use_saved_yes">
                    <strong class="d-block mb-2">Use saved address</strong>
                    <div class="saved-address-display bg-light p-3 rounded">
                      <p class="mb-1"><%= @customer.first_name %> <%= @customer.last_name %></p>
                      <p class="mb-1"><%= @customer.address_line1 %></p>
                      <% if @customer.address_line2.present? %>
                        <p class="mb-1"><%= @customer.address_line2 %></p>
                      <% end %>
                      <p class="mb-1"><%= @customer.city %>, <%= @customer.province.code %> <%= @customer.postal_code %></p>
                      <% if @customer.phone.present? %>
                        <p class="mb-0"><%= @customer.phone %></p>
                      <% end %>
                    </div>
                  </label>
                </div>

                <div class="form-check border rounded p-3">
                  <%= radio_button_tag :use_saved_address, '0', false, class: 'form-check-input', id: 'use_saved_no' %>
                  <label class="form-check-label" for="use_saved_no">
                    <strong>Use a different address</strong>
                  </label>
                </div>
              </div>

              <div id="new-address-fields" style="display: none;">
            <% else %>
              <div id="new-address-fields">
            <% end %>

                <div class="row g-3 mb-3">
                  <div class="col-md-6">
                    <label for="first_name" class="form-label">First Name</label>
                    <%= text_field_tag :first_name, @customer.first_name, 
                        required: !@customer.has_complete_address?, 
                        class: 'form-control' %>
                  </div>
                  
                  <div class="col-md-6">
                    <label for="last_name" class="form-label">Last Name</label>
                    <%= text_field_tag :last_name, @customer.last_name, 
                        required: !@customer.has_complete_address?, 
                        class: 'form-control' %>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="address_line1" class="form-label">Address Line 1</label>
                  <%= text_field_tag :address_line1, '', 
                      required: !@customer.has_complete_address?, 
                      class: 'form-control',
                      placeholder: 'Street address, P.O. box' %>
                </div>

                <div class="mb-3">
                  <label for="address_line2" class="form-label">Address Line 2 (Optional)</label>
                  <%= text_field_tag :address_line2, '', 
                      class: 'form-control',
                      placeholder: 'Apartment, suite, unit, building, floor, etc.' %>
                </div>

                <div class="row g-3 mb-3">
                  <div class="col-md-6">
                    <label for="city" class="form-label">City</label>
                    <%= text_field_tag :city, '', 
                        required: !@customer.has_complete_address?, 
                        class: 'form-control' %>
                  </div>

                  <div class="col-md-6">
                    <label for="province_id" class="form-label">Province</label>
                    <%= select_tag :province_id, 
                        options_from_collection_for_select(Province.order(:name), :id, :name, @customer.province_id),
                        prompt: 'Select Province',
                        required: !@customer.has_complete_address?,
                        class: 'form-select',
                        id: 'province-select',
                        data: { 
                          provinces: Province.all.to_json(only: [:id, :name, :gst_rate, :pst_rate, :hst_rate]),
                          subtotal: @subtotal
                        } %>
                  </div>
                </div>

                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="postal_code" class="form-label">Postal Code</label>
                    <%= text_field_tag :postal_code, '', 
                        required: !@customer.has_complete_address?, 
                        class: 'form-control',
                        placeholder: 'A1A 1A1',
                        pattern: '[A-Za-z]\d[A-Za-z] ?\d[A-Za-z]\d' %>
                  </div>

                  <div class="col-md-6">
                    <label for="phone" class="form-label">Phone Number (Optional)</label>
                    <%= telephone_field_tag :phone, '', 
                        class: 'form-control',
                        placeholder: '(123) 456-7890' %>
                  </div>
                </div>
              </div>
          </div>
        </div>

        <!-- Payment Information -->
        <div class="card mb-4">
          <div class="card-header bg-white">
            <h3 class="h5 mb-0">ðŸ’³ Payment Information</h3>
          </div>
          <div class="card-body">
            <div class="alert alert-success">
              <strong>Secure Payment</strong>
              <p class="mb-0 small">Your payment information is encrypted and secure</p>
            </div>

            <div class="mb-3">
              <label for="cardholder_name" class="form-label">Cardholder Name</label>
              <%= text_field_tag :cardholder_name, '', 
                  required: true,
                  class: 'form-control',
                  placeholder: 'Name on card',
                  autocomplete: 'cc-name' %>
            </div>

            <div class="mb-3">
              <label for="card-number-element" class="form-label">Card Number</label>
              <div id="card-number-element" class="form-control" style="height: 40px; padding-top: 10px;"></div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="card-expiry-element" class="form-label">Expiry Date</label>
                <div id="card-expiry-element" class="form-control" style="height: 40px; padding-top: 10px;"></div>
              </div>

              <div class="col-md-6">
                <label for="card-cvc-element" class="form-label">CVC</label>
                <div id="card-cvc-element" class="form-control" style="height: 40px; padding-top: 10px;"></div>
              </div>
            </div>

            <div id="card-errors" role="alert" class="text-danger small"></div>

            <div class="alert alert-warning">
              <p class="mb-1"><strong>Test Mode</strong></p>
              <p class="mb-0 small">Use test card: <code>4242 4242 4242 4242</code></p>
              <p class="mb-0 small">Any future expiry date and any 3-digit CVC</p>
            </div>
          </div>
        </div>

        <!-- Order Notes -->
        <div class="card mb-4">
          <div class="card-header bg-white">
            <h3 class="h5 mb-0">Order Notes (Optional)</h3>
          </div>
          <div class="card-body">
            <label for="order_notes" class="form-label">Special instructions or delivery notes</label>
            <%= text_area_tag :order_notes, '', 
                class: 'form-control',
                rows: 3,
                placeholder: 'Any special delivery instructions...' %>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-between">
          <%= link_to 'Return to Cart', cart_path, class: 'btn btn-outline-primary btn-lg' %>
          <%= f.submit 'Place Order', class: 'btn btn-success btn-lg px-5', id: 'submit-button', 
              data: { disable_with: 'Processing Payment...' } %>
        </div>

        <%= hidden_field_tag :stripe_payment_method_id, '', id: 'stripe-payment-method-id' %>
      <% end %>
    </div>

    <!-- Order Summary Sidebar -->
    <div class="col-lg-4">
      <div class="card sticky-top" style="top: 20px;">
        <div class="card-header bg-white">
          <h3 class="h5 mb-0">Order Summary</h3>
        </div>
        <div class="card-body">
          <% @cart_items.each do |item| %>
            <div class="d-flex mb-3 pb-3 border-bottom">
              <div class="flex-shrink-0 me-3">
                <% if item[:product].cover_image.attached? %>
                  <%= image_tag item[:product].cover_image, alt: item[:product].title, 
                      class: 'rounded', style: 'width: 60px; height: 80px; object-fit: cover;' %>
                <% else %>
                  <div class="bg-gradient text-white rounded d-flex align-items-center justify-content-center" 
                       style="width: 60px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    ðŸ“š
                  </div>
                <% end %>
              </div>
              <div class="flex-grow-1">
                <p class="mb-1 fw-semibold small"><%= item[:product].title %></p>
                <p class="mb-1 text-muted small">Qty: <%= item[:quantity] %></p>
                <p class="mb-0 text-muted small"><%= number_to_currency(item[:product].current_price) %> each</p>
              </div>
              <div class="text-end">
                <strong><%= number_to_currency(item[:product].current_price * item[:quantity]) %></strong>
              </div>
            </div>
          <% end %>

          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal (<%= pluralize(@cart_items.sum { |i| i[:quantity] }, 'item') %>):</span>
            <strong><%= number_to_currency(@subtotal) %></strong>
          </div>
          
          <div class="d-flex justify-content-between mb-2 text-muted">
            <span>Tax:</span>
            <span id="tax-display">Select province</span>
          </div>

          <hr>

          <div class="d-flex justify-content-between mb-2 fs-5 fw-bold">
            <span>Total:</span>
            <span id="total-display"><%= number_to_currency(@subtotal) %>+</span>
          </div>
          <p class="text-muted small fst-italic mb-0">Final amount calculated after selecting province</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Load Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const stripeKey = '<%= Rails.configuration.stripe[:publishable_key].to_s %>';
    
    if (!stripeKey || stripeKey === '') {
      console.error('Stripe publishable key not found!');
      return;
    }
    
    const stripe = Stripe(stripeKey);
    const elements = stripe.elements();
    
    const cardNumberElement = elements.create('cardNumber', {
      style: {
        base: {
          fontSize: '16px',
          color: '#212529',
          '::placeholder': { color: '#6c757d' }
        },
        invalid: { color: '#dc3545' }
      }
    });
    
    const cardExpiryElement = elements.create('cardExpiry', {
      style: {
        base: {
          fontSize: '16px',
          color: '#212529',
          '::placeholder': { color: '#6c757d' }
        },
        invalid: { color: '#dc3545' }
      }
    });
    
    const cardCvcElement = elements.create('cardCvc', {
      style: {
        base: {
          fontSize: '16px',
          color: '#212529',
          '::placeholder': { color: '#6c757d' }
        },
        invalid: { color: '#dc3545' }
      }
    });
    
    cardNumberElement.mount('#card-number-element');
    cardExpiryElement.mount('#card-expiry-element');
    cardCvcElement.mount('#card-cvc-element');
    
    const displayError = document.getElementById('card-errors');
    
    [cardNumberElement, cardExpiryElement, cardCvcElement].forEach(element => {
      element.on('change', function(event) {
        displayError.textContent = event.error ? event.error.message : '';
      });
    });
    
    const form = document.getElementById('checkout-form');
    const submitButton = document.getElementById('submit-button');
    
    form.addEventListener('submit', async function(event) {
      event.preventDefault();
      submitButton.disabled = true;
      
      const cardholderName = document.getElementById('cardholder_name').value;
      
      if (!cardholderName) {
        displayError.textContent = 'Please enter the cardholder name';
        submitButton.disabled = false;
        return;
      }
      
      const {error, paymentMethod} = await stripe.createPaymentMethod({
        type: 'card',
        card: cardNumberElement,
        billing_details: { name: cardholderName }
      });
      
      if (error) {
        displayError.textContent = error.message;
        submitButton.disabled = false;
      } else {
        document.getElementById('stripe-payment-method-id').value = paymentMethod.id;
        HTMLFormElement.prototype.submit.call(form);
      }
    });
    
    // Handle saved address radio buttons
    const radios = document.querySelectorAll('input[name="use_saved_address"]');
    const newAddressFields = document.getElementById('new-address-fields');
    
    if (radios.length > 0 && newAddressFields) {
      radios.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === '0') {
            newAddressFields.style.display = 'block';
            newAddressFields.querySelectorAll('input[required], select[required]').forEach(field => {
              field.required = true;
            });
          } else {
            newAddressFields.style.display = 'none';
            newAddressFields.querySelectorAll('input, select').forEach(field => {
              field.required = false;
            });
          }
        });
      });
    }
    
    // Province change handler for tax calculation
    const provinceSelect = document.getElementById('province-select');
    if (provinceSelect) {
      const provinces = JSON.parse(provinceSelect.dataset.provinces);
      const subtotal = parseFloat(provinceSelect.dataset.subtotal);
      
      const initialProvinceId = parseInt(provinceSelect.value);
      if (initialProvinceId) {
        calculateAndDisplayTax(initialProvinceId);
      }
      
      provinceSelect.addEventListener('change', function() {
        calculateAndDisplayTax(parseInt(this.value));
      });
      
      function calculateAndDisplayTax(provinceId) {
        const province = provinces.find(p => p.id === provinceId);
        
        if (province) {
          const gst = subtotal * (province.gst_rate / 100);
          const pst = subtotal * (province.pst_rate / 100);
          const hst = subtotal * (province.hst_rate / 100);
          const totalTax = gst + pst + hst;
          const total = subtotal + totalTax;
          
          const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-CA', {
              style: 'currency',
              currency: 'CAD'
            }).format(amount);
          };
          
          document.getElementById('tax-display').textContent = formatCurrency(totalTax);
          document.getElementById('total-display').textContent = formatCurrency(total);
        } else {
          document.getElementById('tax-display').textContent = 'Select province';
          document.getElementById('total-display').textContent = new Intl.NumberFormat('en-CA', {
            style: 'currency',
            currency: 'CAD'
          }).format(subtotal) + '+';
        }
      }
    }
  });
</script>